# Домашнее задание №1 по курсу "SRE: Cтратегия и методы" от МТС.Тета

## Идентификационные данные

Имя проекта: Проект для студента igor.shokhov

Namespace: sre-cource-student-114

## Описание

В этом репозитории содержится Ansible playbook для развёртывания HA кластера PostgreSQL с использованием Patroni, etcd и HAproxy, а также Helm chart для деплоя учебного проекта weather-api в Kubernetes.

Плейбук основан на репозитории [postgresql_cluster](https://github.com/vitabaks/postgresql_cluster) за авторством [vitabaks](https://github.com/vitabaks). Мной была написана и добавлена роль `initdb`, которая создаёт базу, её схему, а также пользователя и предоставляет ему необходимые права для работы с ней.

## Использование

### Предварительные шаги

Предварительно необходимо подготовить 6 инстансов VM – три виртуальных машины для нод etcd, две для БД c Patroni и одну с публичным IP-адресом под балансер. На все инстансы при создании потребуется добавить свой ключ для доступа к ним по SSH.

После всех подготовительных действий подключитесь по SSH к VM с ролью балансера и единственной VM с публичным IP-адресом следующей командой:
`ssh -A USERNAME@PUBLIC_IP`, где `USERNAME` – пользователь, добавленный на сервер при его создании, а `PUBLIC_IP` – его реальный IP.

Ключ `-A` при подключении позволит пробросить ваш SSH-ключ на сервер, так как этот сервер фактически будет использоваться как управляющий сервер для Ansible и именно с него Ansible будет ходить по приватным IP остальных целевых VM с использованием проброшенного ключа для выполнения всех команд плейбуков.

### Развёртывание кластера

После успешного подключения склонируйте этот репозиторий и перейдите в директорию `postgresql_cluster`:

`git clone https://github.com/Girag/sre-course-mts-teta-hw01.git && cd sre-course-mts-teta-hw01/postgresql_cluster`

В файле `inventory` директории `postgresql_cluster` понадобится скорректировать приватные IP-адреса для VM в соответствующих группах хостов. `PUBLIC_IP` нужно заменить на публичный IP хоста-балансировщика. Значение `ansible_user` тоже должно быть скорректировано на имя пользователя, добавленного при создании виртуальных машин.

Выполнив все правки можно запускать раскатку кластера плейбуком при помощи следующей команды:

`ansible-playbook deploy_pgcluster.yml`

После успешного её завершения запустите плейбук для подготовки БД для нашего приложения:

`ansible-playbook initdb.yml`

### Деплой приложения

После этого можно приступить к деплою приложения в Kubernetes при помощи Helm. В файле `values.yaml` директории `helm/weather-api` также потребуется скорректировать значение переменной `CONNECTIONSTRINGS__PGCONNECTION`, изменив в ней `PUBLIC_IP` на публичный IP-адрес соответствующей ноды.

Предварительно убедитесь, что на ноде установлен Helm и присутствует корректный файл kubeconfig. Перейдите в директорию `helm` и выполните следующую команду:

`helm install weather-api weather-api --kubeconfig=PATH_TO_YOUR_KUBECONFIG_YAML`, где PATH_TO_YOUR_KUBECONFIG_YAML – путь к конфигурационному файлу для доступа к кластеру Kubernetes.

Если всё было сделано верно, то в течение нескольких минут наше учебное приложение будет успешно задеплоено и готово к работе.

### Проверка работоспособности

Проверить его работоспособность можно простым GET-запросом на IP нашего Ingress-сервиса с соотвествующим значением "Host":

`curl -H "Host: sre-course-hw01.girag.dev" http://INGRESS_IP/WeatherForecast`
